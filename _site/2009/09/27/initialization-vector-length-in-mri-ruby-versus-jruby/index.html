<!doctype html>
<html lang="en" class="no-js">
<head>
	<meta charset="UTF-8">

<title>Initialization Vector Length in MRI Ruby versus JRuby</title>

<link rel="image_src" href="http://www.gravatar.com/avatar/81f0b3e0c5da01fbeb0ca3743662f070?s=100"/>
<meta property="og:image" content="http://www.gravatar.com/avatar/81f0b3e0c5da01fbeb0ca3743662f070?s=100"/>

<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">

<meta name="author" content="Heath Anderson">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="shortcut icon" href="/favicon.ico">

<link rel="stylesheet" type="text/css" media="all" href="/css/main.css">

<link rel="openid2.provider" href="https://open.login.yahooapis.com/openid/op/auth" />
<link rel="openid.server"    href="https://open.login.yahooapis.com/openid/op/auth" />

<link rel="openid2.local_id" href="http://www.flickr.com/photos/heathanderson" />
<link rel="openid.delegate"  href="http://www.flickr.com/photos/heathanderson" />

<link rel="alternate" type="application/rss+xml" title="Heath's Blog of Stuff Feed" href="http://www.heathanderson.net/atom.xml">

<link rel="stylesheet" media="only screen and (max-device-width: 480px)" href="/css/iphone.css" type="text/css" />


</head>
<body>
	<div id="container">
		<header>
      <div id="header">
  <a id="logo" title="Heath's Blog of Stuff" href="/"><img alt="Heath's Blog of Stuff" src="/images/logo.png"></a>
  <div id="categories_menu">
    <ul class="sf-menu sf-js-enabled">
      <li class="cat-item"><a href="/about.html">About</a></li>
			<li class="cat-item"><a href="http://www.twitter.com/heathanderson">Twitter</a></li>
			<li class="cat-item"><a href="http://www.facebook.com/heathanderson">Facebook</a></li>
		</ul>
  </div>
</div> <!-- end #page_menu -->
		</header>

		<div id="main" role="main">
      <h1>Initialization Vector Length in MRI Ruby versus JRuby</h1> 
<div class="small">Sunday, September 27, 2009</div>

<p>When using OpenSSL encryption in standard Ruby, the length of an initialization vector (IV) can apparently be as large as you want it to be as long as it is at least the minimum size. This is odd. This can also cause trouble when switching over to JRuby. JRuby appear to be much pickier about IV length.</p>

<p>This works in MRI but not in JRuby:</p>

<div class="highlight"><pre><code class="ruby">  <span class="n">unencrypted_data</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span>

  <span class="n">des</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Cipher</span><span class="o">::</span><span class="no">Cipher</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;des-ede3-cbc&quot;</span><span class="p">)</span>
  <span class="n">des</span><span class="o">.</span><span class="n">encrypt</span>
  <span class="n">des</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;0123456789abcdef01234567890&#39;</span>

  <span class="n">des</span><span class="o">.</span><span class="n">iv</span> <span class="o">=</span> <span class="s2">&quot;ed87acdcca419954edccb736f7dc77a74f5ac8dfe3861c3d5f77248e21592131a5423d63ff91f07956ce1aa386f8359931b5&quot;</span> <span class="c1"># 100 characters</span>
  <span class="n">encrypted_data</span> <span class="o">=</span> <span class="n">des</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">unencrypted_data</span><span class="p">)</span> <span class="o">+</span> <span class="n">des</span><span class="o">.</span><span class="n">final</span>

  <span class="nb">puts</span> <span class="n">encrypted_data</span>
</code></pre>
</div>


<p>JRuby gives you this very helpful message:<br/>
@ruby_string_encryption.rb:27:in `encrypt': No message available (OpenSSL::Cipher::CipherError)<br/>
from ruby_string_encryption.rb:37@</p>

<p>Change the IV to 8 characters and everything works fine.</p>

<p><em>Update 10/14/2009</em> The code that I originally posted was incorrect. I have updated it. Also I opened a <a href="http://jira.codehaus.org/browse/JRUBY-4012">ticket </a>for this issue. </p>

<p>If you are looking for what size an initialization vector should be check out my post on <a href="http://www.heathanderson.net/2009/09/25/ruby-string-encryption/">encrypting a string with Ruby</a>.</p>

		



		</div>

		<footer>
      <div id="footer" class="small">
  <form onsubmit="return simpleSearch(this)" method="get" id="searchForm" style="display:none">
    <input type="search" name="q" placeholder="Search this site..." results="5"> 
    <!--[if IE ]>
    <input type="submit" value="Search">
    <![endif]-->
  </form>
  <noscript>
  	You can search this site using <a href="http://www.google.com/search?q=site:www.heathanderson.net">Google</a>.
  </noscript>

<script type="text/javascript">
function simpleSearch(form) {
  var q = window.encodeURIComponent(form["q"].value);
  var url = "http://www.google.com/search?q=site:www.heathanderson.net ";
  url = url + q;window.location = url;
  return false;
}

document.getElementById('searchForm').style.display = "block";
</script>

Subscribe to the <a href="/atom.xml">RSS feed</a> or <a href="http://www.twitter.com/heathanderson">follow me on twitter</a><br/>

Copyright &copy; Heath Anderson.<br/>

<img src="/images/html5-badge.png" alt="HTML5 Badge" class="badge"/>

</div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setaccount', 'Ua-18390372-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

<!-- Prompt IE 6 users to install Chrome Frame. Remove this if you want to support IE 6.
       chromium.org/developers/how-tos/chrome-frame-getting-started -->
  <!--[if lt IE 7 ]>
    <script defer src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
    <script defer>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
  <![endif]-->

		</footer>
	</div>
</body>
</html>
