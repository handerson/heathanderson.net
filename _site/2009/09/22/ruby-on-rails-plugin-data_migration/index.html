<!doctype html>
<html lang="en" class="no-js">
<head>
	<meta charset="UTF-8">

<title>Ruby on Rails Plugin: data_migration</title>

<link rel="image_src" href="http://www.gravatar.com/avatar/81f0b3e0c5da01fbeb0ca3743662f070?s=100"/>
<meta property="og:image" content="http://www.gravatar.com/avatar/81f0b3e0c5da01fbeb0ca3743662f070?s=100"/>

<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">

<meta name="author" content="Heath Anderson">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="shortcut icon" href="/favicon.ico">

<link rel="stylesheet" type="text/css" media="all" href="/css/main.css">

<link rel="openid2.provider" href="https://open.login.yahooapis.com/openid/op/auth" />
<link rel="openid.server"    href="https://open.login.yahooapis.com/openid/op/auth" />

<link rel="openid2.local_id" href="http://www.flickr.com/photos/heathanderson" />
<link rel="openid.delegate"  href="http://www.flickr.com/photos/heathanderson" />

<link rel="alternate" type="application/rss+xml" title="Heath's Blog of Stuff Feed" href="http://www.heathanderson.net/atom.xml">

<link rel="stylesheet" media="only screen and (max-device-width: 480px)" href="/css/iphone.css" type="text/css" />


</head>
<body>
	<div id="container">
		<header>
      <div id="header">
  <a id="logo" title="Heath's Blog of Stuff" href="/"><img alt="Heath's Blog of Stuff" src="/images/logo.png"></a>
  <div id="categories_menu">
    <ul class="sf-menu sf-js-enabled">
      <li class="cat-item"><a href="/about.html">About</a></li>
			<li class="cat-item"><a href="http://www.twitter.com/heathanderson">Twitter</a></li>
			<li class="cat-item"><a href="http://www.facebook.com/heathanderson">Facebook</a></li>
		</ul>
  </div>
</div> <!-- end #page_menu -->
		</header>

		<div id="main" role="main">
      <h1>Ruby on Rails Plugin: data_migration</h1> 
<div class="small">Tuesday, September 22, 2009</div>

<p>data_migration allows you to separate data you need to load from your normal database migrations in a minimal way. While developing the new version of our flagship site, <a href="http://www.knetwit.com">Knetwit</a>, we decided we needed to separate our data migrations (initial settings and the like) from our structural migrations. We decided the easiest way to do this was to modify the existing Rails migration to allow for a new data migration. So we did.</p>

<h3>Install Plugin</h3>

<div class="highlight"><pre><code class="ruby"> 
  <span class="n">script</span><span class="o">/</span><span class="n">plugin</span> <span class="n">install</span> <span class="n">git</span><span class="ss">:/</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">handerson</span><span class="o">/</span><span class="n">data_migration</span><span class="o">.</span><span class="n">git</span>
</code></pre>
</div>


<h3>Generate Migration</h3>

<div class="highlight"><pre><code class="ruby"> 
  <span class="n">script</span><span class="o">/</span><span class="n">generate</span> <span class="n">data_migration</span> <span class="no">BlockedDomains</span> 
</code></pre>
</div>


<div class="highlight"><pre><code class="ruby">  <span class="n">exists</span>  <span class="n">db</span><span class="o">/</span><span class="n">data</span>
  <span class="n">create</span>  <span class="n">db</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">20090915161242</span><span class="n">_settings</span><span class="o">.</span><span class="n">rb</span><span class="o">[/</span><span class="n">sourcecode</span><span class="o">]</span>
</code></pre>
</div>


<p>db/data/20090915161242_settings.rb:</p>

<div class="highlight"><pre><code class="ruby"> 
  <span class="k">class</span> <span class="nc">BlockedDomains</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre>
</div>


<p>Add your data:</p>

<div class="highlight"><pre><code class="ruby"> 
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
    <span class="no">BlockedEmailDomain</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s2">&quot;mailinator.com&quot;</span><span class="p">)</span>
    <span class="no">BlockedEmailDomain</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s2">&quot;spamherelots.com&quot;</span><span class="p">)</span>
    <span class="no">BlockedEmailDomain</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s2">&quot;disposeamail.com&quot;</span><span class="p">)</span>
  <span class="k">end</span>
</code></pre>
</div>


<h3>Run Migration</h3>

<div class="highlight"><pre><code class="ruby">  <span class="n">rake</span> <span class="n">db</span><span class="ss">:data:migrate</span>
</code></pre>
</div>


<div class="highlight"><pre><code class="ruby"> 
  <span class="o">==</span>  <span class="no">BlockedDomains</span><span class="p">:</span> <span class="n">migrating</span> <span class="o">===========================================================</span>
  <span class="o">==</span>  <span class="no">BlockedDomains</span><span class="p">:</span> <span class="n">migrated</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">0020</span><span class="n">s</span><span class="p">)</span> <span class="o">==================================================</span>
</code></pre>
</div>


<p>db:data:migrate adds the data migration version number to the 'schema_migrations' table so it will not be ran again.</p>

<p>Code at Github:<br/>
<a href="http://github.com/handerson/data_migration">http://github.com/handerson/data_migration</a></p>

		



		</div>

		<footer>
      <div id="footer" class="small">
  Subscribe to the <a href="/atom.xml">RSS feed</a> or <a href="http://www.twitter.com/heathanderson">follow me on twitter</a><br/>
  Copyright &copy; Heath Anderson. 

  <form onsubmit="return simpleSearch(this)" method="get" id="searchForm" style="display:none">
    <input type="search" name="q" placeholder="Search this site..." results="5" autosave="blog_of_stuff_search"> 
    <!--[if IE ]>
    <input type="submit" value="Search">
    <![endif]-->
  </form>
  <noscript>
  	You can search this site using <a href="http://www.google.com/search?q=site:www.heathanderson.net">Google</a>.
  </noscript>

<script type="text/javascript">
function simpleSearch(form) {
  var q = window.encodeURIComponent(form["q"].value);
  var url = "http://www.google.com/search?q=site:www.heathanderson.net ";
  url = url + q;window.location = url;
  return false;
}

document.getElementById('searchForm').style.display = "block";
</script>

</div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setaccount', 'Ua-18390372-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

<!-- Prompt IE 6 users to install Chrome Frame. Remove this if you want to support IE 6.
       chromium.org/developers/how-tos/chrome-frame-getting-started -->
  <!--[if lt IE 7 ]>
    <script defer src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
    <script defer>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
  <![endif]-->

		</footer>
	</div>
</body>
</html>
